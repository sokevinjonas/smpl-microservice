name: CI/CD Pipeline to VPS

on:
  push:
    branches:
      - main # Le d√©ploiement se lance quand on push sur main

jobs:
  validate:
    name: üîç Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Basic Syntax Check
        run: |
          python -m py_compile app.py smpl_engine.py utils/pose_estimation.py
          echo "‚úÖ Syntax check passed."

  deploy:
    name: üöÄ Deploy to VPS (SSH)
    runs-on: ubuntu-latest
    needs: validate # Ne se lance QUE si la phase validate r√©ussit

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Execute Remote Deployment via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          # Utiliser SOIT le mot de passe, SOIT la cl√© SSH (recommand√©)
          password: ${{ secrets.VPS_PASSWORD }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "--- D√©ploiement D√©marr√© sur VPS ---"

            # Aller dans le dossier du projet ou le cloner
            if [ -d "~/smpl-microservice" ]; then
              cd ~/smpl-microservice
              echo "üîÑ R√©pertoire existant, r√©cup√©ration de la derni√®re version..."
              # S'assurer d'√™tre sur la bonne branche et forcer le pull
              git fetch origin main
              git reset --hard origin/main
            else
              echo "‚¨áÔ∏è Cl√¥nage initial du d√©p√¥t..."
              cd ~
              git clone https://github.com/sokevinjonas/smpl-microservice.git
              cd ~/smpl-microservice
            fi

            # Lancer le script de d√©ploiement interne qui g√®re Docker Compose
            chmod +x deploy.sh
            ./deploy.sh

            echo "--- D√©ploiement VPS Termin√© avec succ√®s ---"
